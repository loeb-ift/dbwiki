# DB-GPT-WEBUI

这是一个基于 Vanna.ai 和 Flask 的智能数据库问答系统，提供直观的图形界面，让用户可以通过自然语言与数据库进行交互。系统支持多用户管理、数据集上传、AI 模型训练以及智能 SQL 生成，为数据分析提供强大支持。

## 核心功能

- **自然语言转 SQL**：通过大型语言模型 (LLM) 将用户的自然语言问题转换为可执行的 SQL 查询
- **多用户支持**：每个用户拥有独立的训练数据和数据集，确保数据隔离和安全
- **灵活的数据集管理**：支持上传 CSV 文件创建数据集，管理多个数据集
- **AI 驱动的模型训练**：通过提供 DDL、业务文档和 SQL 问答配对来训练自定义模型
- **自动数据库分析**：对整个数据库进行元分析，生成 SQL 查询思考过程总结
- **数据可视化**：自动生成交互式图表，直观展示查询结果
- **多 LLM 支持**：兼容多种 LLM 提供商，包括本地 Ollama 和 OpenAI 等
- **动态日志分析**：记录并分析每次查询过程，提供深入的调试信息
- **安全的用户认证**：支持密码哈希认证，增强系统安全性

## 技术架构

```
┌───────────────┐     ┌────────────────────┐     ┌─────────────────┐
│  前端界面     │────▶│  Flask Web 服务    │────▶│  Vanna 核心引擎 │
│  (HTML/CSS/JS)│◀────│  (Python)          │◀────│  (Python)       │
└───────────────┘     └────────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
┌───────────────┐     ┌────────────────────┐     ┌─────────────────┐
│ SQLite 数据库 │◀────│  SQLAlchemy ORM    │◀────│  LLM 接口层     │
│ (用户数据)    │     │  (Python)          │     │  (Ollama/OpenAI)│
└───────────────┘     └────────────────────┘     └─────────────────┘
```

系统采用模块化设计，主要包括：
- **Web 服务层**：基于 Flask 框架，处理 HTTP 请求和用户交互
- **业务逻辑层**：封装核心功能，包括用户认证、数据集管理、模型训练等
- **数据访问层**：使用 SQLAlchemy 与 SQLite 数据库交互
- **AI 集成层**：通过 Vanna.ai 封装与各种 LLM 服务的交互

## 快速开始

### 环境准备

1. 确保安装了 Python 3.8 或更高版本
2. 克隆项目仓库
3. 安装依赖包

```bash
pip install -r requirements.txt
```

4. 配置环境变量

复制 `.env.example` 文件为 `.env`，然后根据需要编辑配置：

```bash
cp .env.example .env
```

您需要**选择一种** LLM 提供商并填入对应的设置：

- **本地 Ollama 配置**
  ```
  OLLAMA_HOST=http://localhost:11434
  OLLAMA_MODEL=your-model-name:latest
  ```

- **OpenAI 配置**
  ```
  OPENAI_API_KEY="sk-..."
  OPENAI_MODEL="gpt-4-turbo"
  ```

### 启动应用

```bash
python run.py
```

应用程序将在 `0.0.0.0:5004` 上运行，您可以在浏览器中访问 `http://localhost:5004`。

## 使用指南

### 1. 用户认证

使用在 `.env` 文件中配置的用户名和密码登录系统。系统支持两种用户配置格式：

- 简单格式：`{"username": "password"}`
- 完整格式：`{"username": {"password": "...", "is_admin": true/false}}`

默认情况下，如果没有配置用户，系统会创建一个测试用户 `testuser/password`。

### 2. 数据集管理

- **创建数据集**：点击右上角的「+ 新增」按钮，输入数据集名称并上传 CSV 文件
- **选择数据集**：从下拉菜单中选择要操作的数据集
- **管理数据集**：支持重命名和删除数据集操作

上传的 CSV 文件会自动转换为 SQLite 数据表，方便后续查询和分析。

### 3. 模型训练

选择数据集后，可以开始准备训练数据：

- **DDL 管理**：系统会自动从上传的数据表中提取 DDL 信息
- **业务文档**：添加与数据集相关的业务知识、字段定义和常用缩写
- **SQL 问答配对**：添加自然语言问题与对应 SQL 查询的配对，帮助模型学习

准备好训练数据后，点击「重新训练整个模型」按钮开始训练过程。系统会将数据向量化并建立索引，用于后续的查询处理。

### 4. 提问与查询

模型训练完成后，可以通过自然语言提问：

1. 在输入框中输入您的问题
2. 系统会自动检索相关信息并生成 SQL 查询
3. 执行 SQL 查询并返回结果
4. 自动生成可视化图表（如果适用）
5. 提供查询结果的自然语言解释

提问流程包括以下核心步骤：

- 检索相关上下文信息（DDL、文档、相似问答）
- 请求 LLM 进行综合分析
- 生成 SQL 查询
- 执行查询并获取结果
- 生成可视化图表和后续问题建议

### 5. 数据库自动分析

点击「资料库自动分析」按钮，系统会对所有训练材料进行全面的元分析，生成一份关于「如何查询这个数据库」的思考过程总结。

分析过程包括：

- 收集所有训练数据（DDL、文档、问答配对）
- 加载分析提示词模板
- 请求 LLM 生成 SQL 查询思考过程分析表
- 保存分析结果供后续参考

## 项目结构

```
dbwiki/
├── app/                  # 主应用程序目录
│   ├── blueprints/       # Flask 蓝图模块
│   │   ├── ask.py        # 提问与查询接口
│   │   ├── auth.py       # 用户认证接口
│   │   ├── datasets.py   # 数据集管理接口
│   │   ├── training.py   # 模型训练接口
│   │   └── prompts.py    # 提示词管理接口
│   ├── core/             # 核心功能实现
│   ├── utils/            # 工具函数
│   ├── __init__.py       # 应用程序初始化
│   ├── main.py           # 主路由
│   └── vanna_wrapper.py  # Vanna AI 封装
├── templates/            # HTML 模板
├── static/               # 静态资源
├── prompts/              # 提示词模板
├── training_data/        # 示例训练数据
├── tests/                # 测试文件
├── run.py                # 应用程序入口
└── requirements.txt      # 项目依赖
```

## 环境变量配置

| 环境变量 | 说明 | 默认值 |
|---------|------|-------|
| SECRET_KEY | Flask 会话密钥 | 自动生成 |
| SESSION_TIMEOUT_MINUTES | 会话超时时间(分钟) | 30 |
| APP_USERS | JSON 格式的用户配置 | {"testuser": "password"} |
| OLLAMA_HOST | Ollama 服务地址 | http://localhost:11434 |
| OLLAMA_MODEL | Ollama 模型名称 | - |
| OPENAI_API_KEY | OpenAI API 密钥 | - |
| OPENAI_MODEL | OpenAI 模型名称 | - |
| FLASK_DEBUG | 是否启用调试模式 | False |
| PORT | 应用程序端口 | 5004 |

## 开发指南

### 目录结构说明

- **app/blueprints/**：包含所有 API 端点，按功能模块分类
- **app/core/**：实现核心业务逻辑和与 Vanna AI 的交互
- **app/utils/**：提供各种辅助功能和工具函数
- **templates/**：包含前端界面模板
- **static/**：包含前端 JavaScript 和 CSS 文件

### 添加新功能

1. 在 `app/blueprints/` 中创建新的蓝图文件
2. 在 `app/__init__.py` 中注册新蓝图
3. 实现必要的模型和工具函数
4. 更新前端模板和静态资源

### 测试

项目包含多种测试脚本，可以使用以下命令运行：

```bash
python -m pytest tests/
```

## 故障排除

### 常见问题

1. **无法连接到 LLM 服务**
   - 检查 `.env` 文件中的 LLM 配置是否正确
   - 确认 Ollama 服务是否正在运行
   - 检查网络连接和防火墙设置

2. **上传 CSV 文件失败**
   - 确保文件格式正确且没有损坏
   - 检查文件大小是否超过系统限制

3. **生成的 SQL 查询不正确**
   - 增加更多的训练数据，特别是相关的 SQL 问答配对
   - 提供更详细的业务文档
   - 检查 DDL 信息是否正确

4. **会话超时**
   - 可以在 `.env` 文件中调整 `SESSION_TIMEOUT_MINUTES` 值

## 安全注意事项

- 在生产环境中，请使用强密码并配置 `SESSION_COOKIE_SECURE = True`
- 建议使用密码哈希而非明文密码
- 定期备份用户数据和训练数据
- 限制对 LLM 服务的访问权限

## 许可证

本项目采用 MIT 许可证 - 详见 LICENSE 文件

## 贡献指南

欢迎提交问题和改进建议。请参考 CONTRIBUTING.md 文件了解更多信息。

## 致谢

特别感谢以下开源项目提供的支持：

- [Vanna.ai](https://vanna.ai/) - AI 驱动的 SQL 查询生成
- [Flask](https://flask.palletsprojects.com/) - Web 框架
- [Plotly](https://plotly.com/) - 数据可视化库
- [SQLAlchemy](https://www.sqlalchemy.org/) - 数据库 ORM
- [Pandas](https://pandas.pydata.org/) - 数据处理库
