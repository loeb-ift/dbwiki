# DB-GPT-WEBUI

這是一個基於 Vanna.ai 和 Flask 的網頁應用程式，旨在提供一個圖形化介面，讓使用者可以透過自然語言與資料庫進行互動。使用者可以上傳自己的資料集、訓練 AI 模型，並透過提問來查詢資料。

## 功能特色

- **多使用者支援**：每個使用者擁有獨立的訓練資料和資料集。
- **圖形化訓練介面**：透過網頁介面輕鬆管理 DDL、業務文件和 SQL 問答配對。
- **動態日誌分析**：在每次提問後，系統會自動收集所有檢索過程的日誌，並發送給大型語言模型 (LLM) 進行分析，以提供更深入的洞察。
- **提示詞歷史紀錄**：自動保存每一次發送給 LLM 的完整提示詞，方便使用者進行分析和優化。
- **分塊處理**：自動將過長的提示詞分塊，以避免超出 LLM 的處理上限。

## 安裝與啟動

### 1. 環境準備

在開始之前，請確保您已經安裝了 Python 3.8 或更高版本。接著，執行以下步驟：

- **安裝依賴套件**:
  ```bash
  pip install -r requirements.txt
  ```

- **設定環境變數**:
  複製 `.env.example` 檔案為 `.env`，然後編輯 `.env` 檔案。
  ```bash
  cp .env.example .env
  ```
  您需要**選擇一種** LLM 供應商並填入對應的設定。程式會自動偵測您啟用的設定。

  - **範例：使用本地端的 Ollama**
    ```
    # --- LLM Configuration ---
    OLLAMA_HOST=http://your-ollama-server-ip:11434
    OLLAMA_MODEL=your-model-name:latest
    ```
  - **範例：使用 OpenAI**
    ```
    # --- LLM Configuration ---
    OPENAI_API_KEY="sk-..."
    OPENAI_MODEL="gpt-4-turbo"
    ```
  **重要**：請確保一次只啟用一種 LLM 的設定，將其他供應商的設定保持註解狀態。

### 2. 啟動應用程式

完成環境準備後，執行以下指令來啟動 Flask 網頁應用程式：

```bash
python app.py
```

應用程式預設會在 `0.0.0.0:5001` 上執行。您可以在瀏覽器中開啟 `http://localhost:5001` 來存取網頁介面。

## 網頁介面使用方法

### 1. 登入

請使用您在 `.env` 檔案中透過 `APP_USERS` 變數設定的帳號和密碼進行登入。

### 2. 新增與選擇資料集

- **新增資料集**：點擊右上角的「+ 新增」按鈕。在彈出的視窗中，為您的資料集命名，並選擇一個或多個要上傳的 CSV 檔案。系統會為每個 CSV 檔案在資料庫中建立一個對應的資料表。
- **選擇資料集**：從下拉式選單中選擇您想要操作的資料集。選擇後，下方的訓練介面將會被啟用。

### 3. 管理訓練資料

選擇資料集後，您可以開始管理該資料集的訓練資料。

- **選擇資料表**：您可以選擇針對「全局/跨資料表」或某個特定的資料表 (CSV) 來進行訓練。
- **Schema (DDL)**：當您選擇一個資料表時，其 DDL (資料表定義語言) 會自動顯示在此處。選擇「全局」則會顯示所有資料表的 DDL。
- **知識背景文件**：在此處輸入與所選資料表或整個資料集相關的業務知識、欄位定義、常用縮寫等。您也可以透過檔案上傳的方式來新增。完成後，請點擊「儲存文件」。
- **SQL 問答配對**：在此處新增「問題」（自然語言）與其對應「SQL 語法」的配對。這是訓練模型理解如何將問題轉換為 SQL 的關鍵。您可以手動新增，也可以透過上傳 `.sql` 檔案來批次生成。

### 4. 訓練模型

當您準備好 DDL、文件和問答配對後，點擊「重新訓練整個模型」按鈕。系統會將這些資料向量化並儲存起來，用於後續的提問。

### 5. 提出問題

模型訓練完成後，「提出問題」區塊將會啟用。

1.  在輸入框中用自然語言輸入您的問題（例如：「找出利潤潛力高但銷售不足的產品線」）。
2.  點擊「提出問題」按鈕。
3.  系統會開始執行以下流程，並將結果呈現在對應的區塊：
    - **思考過程**：顯示 Vanna.ai 檢索 DDL、文件和相似問答的詳細步驟。
    - **SQL 查詢思考過程分析表**：顯示由 LLM 根據所有日誌分析後，產生的思考過程摘要。
    - **生成的 SQL**：顯示最終由 AI 生成的可執行 SQL 語法。不保證可以執行!!
    - **思考結果**：**將執行 自然語言轉為SQL 中間AI思索的資料流清晰地呈現，這是理解資料庫、驗證查詢結果最直接的方式。**

### 6. 查看提示詞歷史紀錄

每一次您提出問題時，系統發送給 LLM 進行分析的完整提示詞，都會被自動保存到專案根目錄下的 `prompt_history` 資料夾中。您可以隨時查看這些 `.txt` 檔案，以了解 AI 的「思考過程」，並根據這些資訊來優化您的訓練資料或提示詞範本 (`prompts/ask_analysis_prompt.txt`)。
