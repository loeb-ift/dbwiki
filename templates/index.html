<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBWIKI.AI 網頁介面</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 2em; background-color: #f4f4f9; }
        h1, h2, h3 { color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { border: 1px solid #e0e0e0; padding: 1.5em; margin-bottom: 1.5em; border-radius: 5px; }
        textarea { width: 98%; height: 120px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; }
        button { padding: 0.6em 1.2em; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .form-group { margin-bottom: 1em; display: flex; align-items: center; gap: 10px; }
        .form-group label { font-weight: bold; }
        select { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .table-container { width: 100%; overflow-x: auto; margin-top: 1em; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: top; }
        th { background-color: #f2f2f2; }
        td textarea { width: 98%; height: 80px; border: 1px solid #eee; }
        td pre { white-space: pre-wrap; background-color: #f8f8f8; padding: 5px; margin: 0; }
        #training-log, #qa-gen-log, #thinking-output, #sql-output, #result-output, #schema-analysis-output, #documentation-output { background-color: #282c34; color: #abb2bf; padding: 10px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; border-radius: 4px; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:2em; border-radius:5px; width:500px; }
        .prompts-table-small-font th, .prompts-table-small-font td { font-size: 0.8em; padding: 6px; }
        .prompts-table-small-font th:nth-child(1), .prompts-table-small-font td:nth-child(1) { width: 25%; }
        .prompts-table-small-font th:nth-child(2), .prompts-table-small-font td:nth-child(2) { width: 40%; }
        .prompts-table-small-font th:nth-child(3), .prompts-table-small-font td:nth-child(3) { width: 10%; }
        .prompts-table-small-font th:nth-child(4), .prompts-table-small-font td:nth-child(4) { width: 25%; }
        .prompts-table-small-font .btn-group button { margin-right: 5px; }
        .scrollable-table-container {
            overflow-x: auto;
            width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 0.5em;
            background-color: #fdfdfd;
        }
        .scrollable-table-container table {
            width: max-content;
            min-width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>資料庫整理介面</h1>
            <a href="/logout" style="text-decoration: none;"><button>登出</button></a>
        </div>

        <div class="section">
            <h2>資料集管理</h2>
            <div class="form-group">
                <label for="dataset-selector">選擇資料集：</label>
                <select id="dataset-selector"></select>
                <button onclick="openNewDatasetModal()">+ 新增</button>
                <button id="edit-dataset-btn" onclick="openEditDatasetModal()" disabled>編輯</button>
                <button id="delete-dataset-btn" onclick="deleteDataset()" disabled>刪除</button>
            </div>
        </div>

        <div id="training-section" class="section" style="display: none;">
            <h2>訓練模型</h2>
            <p>選擇一個資料表 (CSV) 來查看或編輯其專屬的訓練資料，或選擇「全局」來管理跨資料表的邏輯。</p>
            
            <div class="form-group">
                <label for="table-selector">選擇資料表 (CSV)：</label>
                <select id="table-selector"></select>
            </div>

            <h3>a. Schema分析陳述 (DDL)</h3>
            <textarea id="ddl-input" placeholder="選擇資料表後，其 DDL 將顯示於此..." readonly></textarea>
            <br><br>

            <h3>b. 資料的知識背景文件</h3>
            <textarea id="doc-input" placeholder="輸入與所選資料表相關的業務知識，或從下方上傳檔案..."></textarea>
            <div class="form-group" style="margin-top: 10px;">
                <label for="doc-file-input">或上傳文件 (.txt, .md):</label>
                <input type="file" id="doc-file-input" accept=".txt,.md" onchange="handleDocFileUpload(event)">
            </div>
            <button type="button" onclick="saveDocumentation()">儲存文件</button>
            <br><br>

            <h3>c. SQL 問答配對</h3>
            <div id="qa-list-container" class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                        <button id="select-all-qa-btn" type="button" onclick="selectAllQaRows()">全選</button>
                        <button id="batch-delete-qa-btn" type="button" onclick="batchDeleteQaRows()" disabled>批次刪除</button>
                    </div>
                    <div>
                        <button type="button" onclick="addQaPairRow()">+ 新增問答</button>
                        <button id="save-all-qa-btn" type="button" onclick="saveAllQaModifications()" style="margin-left: 10px;">儲存所有修改</button>
                    </div>
                </div>
                <table id="qa-table">
                    <thead><tr><th><input type="checkbox" id="select-all-checkbox" onchange="selectAllQaRows()"></th><th>SQL說明 (問題)</th><th>SQL語法</th><th>操作</th></tr></thead>
                    <tbody id="qa-table-body"></tbody>
                </table>
                <div id="qa-pagination-controls" style="margin-top: 1em; text-align: center;">
                    <button id="prev-page-btn" disabled>上一頁</button>
                    <span id="page-info" style="margin: 0 1em;">第 1 / 1 頁</span>
                    <button id="next-page-btn" disabled>下一頁</button>
                </div>
                <div class="form-group" style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                    <label for="qa-file-input">或上傳檔案生成 (.sql):</label>
                    <input type="file" id="qa-file-input" accept=".sql">
                    <button type="button" id="upload-qa-btn" onclick="uploadQaFile()" style="margin-left: 10px;">上傳並生成</button>
                </div>
                <div id="qa-upload-progress-container" style="margin-top: 10px; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>上傳進度:</span>
                        <span id="qa-upload-percentage">0%</span>
                    </div>
                    <div style="width: 100%; height: 20px; background-color: #f1f1f1; border-radius: 4px;">
                        <div id="qa-upload-progress-bar" style="height: 100%; width: 0; background-color: #4CAF50; border-radius: 4px; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div id="qa-gen-log-container" style="margin-top: 1em; display: none;">
                    <h4>生成日誌：</h4>
                    <pre id="qa-gen-log"></pre>
                </div>
            </div>
            <br>

            <button id="train-model-btn" type="button" onclick="trainModel()" style="display: block; margin: 1em auto; padding: 0.8em 1.5em; font-size: 1.2em;">重新訓練整個模型</button>
            <div style="margin-top: 1em;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>訓練進度:</span>
                    <span id="training-percentage">0%</span>
                </div>
                <div style="width: 100%; height: 20px; background-color: #f1f1f1; border-radius: 4px;">
                    <div id="training-progress-bar" style="height: 100%; width: 0; background-color: #2196F3; border-radius: 4px; transition: width 0.3s;"></div>
                </div>
            </div>
            <div id="training-log-container" style="margin-top: 1em; display: none;">
                <h4>訓練日誌：</h4>
                <pre id="training-log"></pre>
            </div>
            
            <hr style="margin: 2em 0;">

            <div id="auto-analysis-section">
                <h3>資料庫自動分析</h3>
                <p>點擊按鈕，讓 AI 自動分析當前資料庫的結構，並生成建議文件。</p>
                <button id="analyze-schema-btn" type="button" onclick="analyzeSchema()">自動分析資料庫結構</button>
            </div>
        </div>

        <div id="documentation-output-section" class="section" style="display: none;">
            <h2>資料庫結構分析</h2>
            <pre id="documentation-output" style="white-space: pre-wrap; background-color: #f8f8f8; padding: 1em; border-radius: 4px;"></pre>
            
            <hr style="margin: 2em 0;">

            <h2>流水號/料號規則分析</h2>
            <div id="serial-number-analysis-output" style="white-space: pre-wrap; background-color: #f8f8f8; padding: 1em; border-radius: 4px; min-height: 50px;"></div>
        </div>
        
        <div id="prompts-section" class="section" style="display: none;">
            <h2>提示詞管理</h2>
            <p>管理用於模型訓練和查詢的提示詞模板。您可以自定義提示詞，也可以使用全局默認提示詞。</p>
            
            <div class="table-container">
                <table id="prompts-table" class="prompts-table-small-font">
                    <thead><tr><th>提示詞名稱</th><th>功能描述</th><th>全域</th><th>操作</th></tr></thead>
                    <tbody id="prompts-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="ask-section" class="section" style="display: none;">
            <h2>提出問題</h2>
            <p>模型訓練完成後，您可以在這裡對您的資料庫提問。</p>
            <div class="form-group">
                <textarea id="question-input" placeholder="在這裡輸入您的問題..."></textarea>
            </div>
            <button id="ask-button" onclick="ask()">提出問題</button>
            <div id="ask-status-container" style="margin-top: 1em; font-style: italic; color: #555;"></div>
            <div id="results-container" style="margin-top: 1.5em;">
                <div id="thinking-container" style="display: none;">
                    <h3>思考過程：</h3>
                    <div id="thinking-output">
                        <div id="retrieved-qa-container" style="display: none;">
                            <h4>檢索到的相似問答：</h4>
                            <pre id="retrieved-qa-output"></pre>
                        </div>
                        <div id="retrieved-ddl-container" style="display: none;">
                            <h4>檢索到的相關 DDL：</h4>
                            <pre id="retrieved-ddl-output"></pre>
                        </div>
                        <div id="retrieved-doc-container" style="display: none;">
                            <h4>檢索到的相關文件：</h4>
                            <pre id="retrieved-doc-output"></pre>
                        </div>
                    </div>
                </div>
                <div id="analysis-container" style="margin-top: 1.5em; display: none;">
                    <h3>SQL 生成問題：思考過程分析</h3>
                    <div id="original-question-container" style="margin-bottom: 1em;">
                        <h4>1. 原始問題</h4>
                        <p id="original-question-display" style="background-color: #f8f8f8; padding: 0.5em; border-radius: 4px;"></p>
                    </div>
                    <div id="thinking-process-container">
                        <h4>2. 思考過程分析表</h4>
                        <div class="scrollable-table-container">
                            <div id="analysis-output"></div>
                        </div>
                    </div>
                </div>
                <div id="sql-container" style="display: none;">
                    <h3>思考可能的SQL語法</h3>
                    <pre id="sql-output"></pre>
                    <div id="sql-error-container" style="display: none; margin-top: 1em; border: 1px solid #d9534f; border-radius: 4px; padding: 1em; background-color: #f2dede;">
                        <h4 style="color: #a94442; margin-top: 0;">SQL 執行失敗</h4>
                        <p style="color: #a94442;">系統生成的以下 SQL 語法在執行時發生錯誤：</p>
                        <pre id="sql-error-output" style="background-color: #ebcccc; color: #a94442;"></pre>
                        <p style="color: #a94442; margin-top: 1em;">錯誤詳情：</p>
                        <pre id="sql-error-details" style="background-color: #ebcccc; color: #a94442;"></pre>
                    </div>
                </div>
                <div id="chart-container" style="display: none; margin-top: 1.5em;">
                    <h3>視覺化圖表：</h3>
                    <div id="chart-output"></div>
                </div>
                <div id="result-container" style="display: none; margin-top: 1.5em;">
                    <h3>查詢結果：</h3>
                    <pre id="result-output"></pre>
                </div>
                <div id="followup-container" style="display: none; margin-top: 1.5em;">
                    <h3>後續問題建議：</h3>
                    <div id="followup-output"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Dataset Modal -->
    <div id="edit-dataset-modal" class="modal">
        <div class="modal-content">
            <h2>編輯資料集</h2>
            <form id="edit-dataset-form" onsubmit="return false;">
                <input type="hidden" id="edit-dataset-id">
                <p>修改您的資料集名稱。</p>
                <label for="edit-dataset-name">資料集名稱:</label><br>
                <input type="text" id="edit-dataset-name" name="dataset_name" required style="width:95%; margin-bottom:1em;"><br><br>
                
                <h3>CSV 文件管理</h3>
                <div style="margin-bottom:1em;">
                    <p>添加新的 CSV 文件到資料集:</p>
                    <input type="file" id="edit-dataset-files" name="files" accept=".csv" multiple><br>
                    <button type="button" id="add-file-btn" style="margin-top: 10px;">添加文件</button>
                </div>
                
                <div>
                    <p>當前資料集中的文件:</p>
                    <div id="current-files-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 1em;"></div>
                </div>
                
                <div style="text-align:right;">
                    <button type="button" onclick="closeEditDatasetModal()">取消</button>
                    <button type="submit" id="edit-dataset-submit-btn">儲存修改</button>
                </div>
            </form>
        </div>
    </div>

    <div id="new-dataset-modal" class="modal">
        <div class="modal-content">
            <h2>新增資料集</h2>
            <form id="new-dataset-form" onsubmit="return false;">
                <p>為您的資料集命名，並選擇多個要上傳的 CSV 檔案。</p>
                <label for="new-dataset-name">資料集名稱:</label><br>
                <input type="text" id="new-dataset-name" name="dataset_name" required style="width:95%; margin-bottom:1em;"><br><br>
                <label for="new-dataset-files">選擇 CSV 檔案 (可多選):</label><br>
                <input type="file" id="new-dataset-files" name="files" multiple accept=".csv"><br><br>
                <div style="text-align:right;">
                    <button type="button" onclick="closeNewDatasetModal()">取消</button>
                    <button type="submit" id="new-dataset-submit-btn">上傳並創建</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Prompt Modal -->
    <div id="prompt-modal" class="modal">
        <div class="modal-content">
            <h2 id="prompt-modal-title">編輯提示詞</h2>
            <form id="prompt-form" onsubmit="return false;">
                <input type="hidden" id="prompt-id">
                
                <label for="prompt-name">提示詞名稱:</label><br>
                <input type="text" id="prompt-name" name="prompt_name" required style="width:95%; margin-bottom:1em;"><br><br>
                
                <label for="prompt-description">功能描述:</label><br>
                <input type="text" id="prompt-description" name="prompt_description" style="width:95%; margin-bottom:1em;"><br><br>
                
                <label for="prompt-content">提示詞內容:</label><br>
                <textarea id="prompt-content" name="prompt_content" rows="10" style="width:95%; margin-bottom:1em;"></textarea><br><br>
                
                <div style="text-align:right;">
                    <button type="button" onclick="closePromptModal()">取消</button>
                    <button type="submit" id="prompt-submit-btn">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/static/script.js?v=1.4"></script>
</body>
</html>