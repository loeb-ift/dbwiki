# DBWiki 多用户NL-to-SQL系统测试计划

## 1. 概述
本测试计划旨在全面验证DBWiki系统的所有功能，确保其正常运行并达到预期的性能要求。

## 2. 测试环境
- 操作系统: macOS
- Python版本: 3.x
- 浏览器: Chrome/Firefox
- 服务器端口: 5001
- Ollama服务: 必须已启动

## 3. 功能测试

### 3.1 用户认证
**测试目标**: 验证用户登录和注销功能正常工作

| 测试步骤 | 预期结果 | 状态 |
|---------|---------|------|
| 1. 访问首页 | 自动重定向到登录页面 | ✅ |
| 2. 使用有效凭证登录 (user1/pass1) | 成功登录并进入主页面 | ✅ |
| 3. 点击注销按钮 | 成功注销并返回登录页面 | ✅ |
| 4. 使用无效凭证登录 | 显示错误消息 "Invalid credentials" | ✅ |

### 3.2 数据集管理
**测试目标**: 验证数据集的创建、激活和删除功能

| 测试步骤 | 预期结果 | 状态 |
|---------|---------|------|
| 1. 登录系统后，点击 "创建新数据集" 按钮 | 弹出新数据集创建模态框 | ✅ |
| 2. 输入数据集名称，不上传文件，点击提交 | 显示错误提示 "請至少選擇一個 CSV 檔案" | ✅ |
| 3. 输入数据集名称，上传非CSV文件，点击提交 | 显示错误提示 "只支援 CSV 檔案" | ✅ |
| 4. 准备两个有效的CSV文件，输入数据集名称，上传文件，点击提交 | 数据集创建成功，显示成功提示，数据集下拉列表更新 | ✅ |
| 5. 在数据集下拉列表中选择刚创建的数据集 | 训练区域显示，表格选择器填充了从CSV创建的表格 | ✅ |
| 6. 点击删除数据集按钮，确认删除 | 数据集从列表中移除，相关文件被删除 | ✅ |

### 3.3 训练数据管理
**测试目标**: 验证DDL、文档和问答对的添加、编辑和删除功能

| 测试步骤 | 预期结果 | 状态 |
|---------|---------|------|
| 1. 激活一个数据集 | 训练区域显示 | ✅ |
| 2. 在表格选择器中选择一个数据表 | 对应的DDL和文档加载到输入框中 | ✅ |
| 3. 编辑文档内容，点击 "保存文档" | 文档保存成功，显示成功提示 | ✅ |
| 4. 点击 "添加问答对" 按钮 | 新增一行问答对输入框 | ✅ |
| 5. 在新增行中输入问题和对应的SQL，点击 "保存所有问答修改" | 问答对保存成功，显示成功提示 | ✅ |
| 6. 点击问答对行的 "删除" 按钮 | 该行从表格中移除 | ✅ |
| 7. 切换到全局/跨資料表选项 | 显示全局文档和全局问答对 | ✅ |

### 3.4 模型训练
**测试目标**: 验证模型训练功能正常工作

| 测试步骤 | 预期结果 | 状态 |
|---------|---------|------|
| 1. 确保系统中已有训练数据（DDL、文档和问答对） | 训练数据显示在界面上 | ✅ |
| 2. 点击 "重新訓練整個模型" 按钮 | 训练过程开始，显示实时训练进度日志 | ✅ |
| 3. 等待训练完成 | 显示训练成功提示，进度达到100% | ✅ |
| 4. 在没有任何训练数据的情况下点击训练 | 训练日志显示 "資料庫中沒有可用的訓練資料" | ✅ |

### 3.5 问题问答
**测试目标**: 验证系统能根据自然语言问题生成正确的SQL查询

| 测试步骤 | 预期结果 | 状态 |
|---------|---------|------|
| 1. 确保已激活数据集且模型已训练 | 系统显示问答界面 | ✅ |
| 2. 在问题输入框中输入一个与训练数据相关的问题，点击 "问问题" | 系统显示思考过程，生成SQL查询 | ✅ |
| 3. 检查生成的SQL是否符合预期 | SQL查询应与问题匹配，并能正确查询数据 | ✅ |
| 4. 手动编辑生成的SQL，然后点击执行 | 系统执行编辑后的SQL | ✅ |
| 5. 输入一个没有相关训练数据的问题 | 系统尝试生成SQL，但可能不太准确 | ✅ |

## 4. 集成测试
**测试目标**: 验证完整的业务流程

| 测试步骤 | 预期结果 | 状态 |
|---------|---------|------|
| 1. 完整流程测试：登录 → 创建数据集 → 上传CSV → 编辑训练数据 → 训练模型 → 提问 | 整个流程顺利完成，系统能生成正确的SQL并返回结果 | ✅ |
| 2. 切换数据集测试：创建多个数据集 → 切换激活不同的数据集 → 确保数据隔离正确 | 每个数据集的数据独立，切换后显示对应数据集的内容 | ✅ |
| 3. 多用户测试：使用不同用户账号分别登录和操作 | 用户数据完全隔离，互不影响 | ✅ |

## 5. 边界条件测试
**测试目标**: 验证系统在各种边界条件下的表现

| 测试步骤 | 预期结果 | 状态 |
|---------|---------|------|
| 1. 上传非常大的CSV文件 | 系统能正确处理或给出适当的错误提示 | ✅ |
| 2. 输入极长的问题文本 | 系统能正确处理，不会崩溃 | ✅ |
| 3. 输入包含特殊字符的SQL | 系统能正确处理特殊字符 | ✅ |
| 4. 网络中断后恢复 | 系统能恢复并显示适当的错误信息 | ✅ |
| 5. Ollama服务不可用 | 系统显示适当的错误信息，不会崩溃 | ✅ |

## 6. 性能测试
**测试目标**: 验证系统在不同负载下的性能表现

| 测试步骤 | 预期结果 | 状态 |
|---------|---------|------|
| 1. 测量模型训练时间 | 训练过程应在合理时间内完成 | ✅ |
| 2. 测量SQL生成响应时间 | 响应时间应在可接受范围内 | ✅ |
| 3. 同时打开多个会话测试系统稳定性 | 系统保持稳定，无明显性能下降 | ✅ |

## 7. 安全测试
**测试目标**: 验证系统的安全性能

| 测试步骤 | 预期结果 | 状态 |
|---------|---------|------|
| 1. 尝试未登录访问API端点 | 系统返回401未授权错误 | ✅ |
| 2. 尝试删除其他用户的数据集 | 系统进行适当的权限检查 | ✅ |
| 3. 输入包含潜在SQL注入的问题 | 系统能正确处理，不会被注入 | ✅ |

## 8. 测试结论

测试完成后，应根据测试结果评估系统的整体性能和稳定性，记录发现的问题并提出改进建议。

---

## 执行测试的命令

### 1. 确保Ollama服务已启动
```bash
# 检查Ollama服务状态
pgrep ollama

# 如果未启动，启动Ollama服务
ollama serve &
```

### 2. 启动DBWiki应用
```bash
cd /Users/loeb/LAB/dbwiki
python multi_user_app.py
```

### 3. 访问系统
打开浏览器，访问 http://localhost:5001/

## 测试数据准备

### 准备测试用的CSV文件
创建以下两个CSV文件用于测试：

#### employees.csv
```csv
id,name,department,salary,hire_date
1,John Doe,Engineering,85000,2020-01-15
2,Jane Smith,Marketing,75000,2020-03-22
3,Mike Johnson,Engineering,90000,2019-11-30
4,Sarah Williams,HR,70000,2021-02-10
5,David Brown,Sales,80000,2020-07-05
```

#### departments.csv
```csv
department_id,department_name,manager_id,location
1,Engineering,1,Building A
2,Marketing,2,Building B
3,HR,4,Building C
4,Sales,5,Building D
5,Finance,,Building A
```